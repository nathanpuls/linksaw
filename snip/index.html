<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Snip</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-..."
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/milligram@1.4.1/dist/milligram.min.css">
    <link rel="stylesheet" href="add.css">

    <!-- <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" /> -->
    

    <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-auth.js"></script>
    <script src="../profile/header.js"></script>
    <!-- <script src="firebase-config.js"></script> -->
    
    <script>
        var firebaseConfig = {
apiKey: "AIzaSyCauN-vsgUfQJXc5b41NoCnYzi6FIn86MQ",
authDomain: "linkshare-eb70b.firebaseapp.com",
databaseURL: "https://linkshare-eb70b-default-rtdb.firebaseio.com",
projectId: "linkshare-eb70b",
storageBucket: "linkshare-eb70b.appspot.com",
messagingSenderId: "284502085616",
appId: "1:284502085616:web:3f24e3fb844320eef85735",
measurementId: "G-VQ0J98LXYT"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
firebase.analytics();
    </script>
    
  </head>
<body>
    
    <div class="container-middle">
        <h1>Linksaw Snip</h1>
        <button onclick="signInWithGoogle()">Login with Google</button>
        
        
        
          
    </div>

    
 
    
   <script src="add.js"></script>
   <script>
    





firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        // User is signed in.
        // You can redirect to /links or perform other actions here
        window.location.href = '/add';
    } else {
        // User is not signed in. Continue with your existing code.
    }
});

//Initialize Google Sign-In
const googleAuthProvider = new firebase.auth.GoogleAuthProvider();






var username;
function signInWithGoogle() {
firebase.auth().signInWithPopup(googleAuthProvider)
    .then((result) => {
        // This gives you a Google Access Token.
        const token = result.credential.accessToken;
        // The signed-in user info.
        const user = result.user;
        console.log('User signed in:', user);

        // Extract the username from the email without @gmail.com
        let username = user.email.replace(/@gmail\.com$/, '');
        username = username.replace(/\./g, '');

        localStorage.setItem('username', username);

        // Check if the user already exists in the database
        const userRef = firebase.database().ref('users/' + user.uid);
        userRef.once('value')
            .then((snapshot) => {
                if (!snapshot.exists()) {
                    // If the user doesn't exist, add them to the database
                    userRef.set({
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        lastLoginAt: firebase.database.ServerValue.TIMESTAMP,
                        username: username // Set the username in the database
                    });
                } else {
                    // If the user already exists, update the lastLoginAt timestamp
                    userRef.update({ lastLoginAt: firebase.database.ServerValue.TIMESTAMP });
                }

                // Redirect to the dashboard upon successful login
                window.location.href = '/add';
            })
            .catch((error) => {
                console.error('Error checking/updating user in the database:', error);
            });
    })
    .catch((error) => {
        // Handle errors here.
        const errorCode = error.code;
        const errorMessage = error.message;
        console.error(`Google Sign-In Error: ${errorCode} - ${errorMessage}`);
    });
}

function signOut() {
firebase.auth().signOut().then(() => {
    console.log('User signed out.');
    // Redirect to the home page after signing out
    window.location.href = '/';
}).catch((error) => {
    console.error('Sign-out error:', error);
});
}






   </script> 
  </body>
</html>
