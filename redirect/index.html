<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-database.js"></script>

<!-- Include your configuration -->
<script src="config.js"></script>

<!-- Your Firebase-related script -->
<script>
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  var database = firebase.database();

  // Extract parameters from the URL
  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
  }

  // Extract username and link name from the URL parameters
  var username = getParameterByName('username');
  var linkname = getParameterByName('linkname');

  console.log('Username:', username, 'Linkname:', linkname);

  // Fetch the redirection URL from the database using async/await
  async function fetchLinkData() {
  try {
    var userSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');

    if (userSnapshot.exists()) {
      var userId = Object.keys(userSnapshot.val())[0]; // Get the user ID

      var linkSnapshot = await database.ref('links/' + userId).orderByChild('name').equalTo(linkname).once('value');

      if (linkSnapshot.exists()) {
        var linkData = linkSnapshot.val();
        var linkKey = Object.keys(linkData)[0]; // Get the link key

        // Check if the linkData has the 'url' property
        if (linkData[linkKey] && 'url' in linkData[linkKey]) {
          // Get the URL from linkData
          var url = linkData[linkKey].url;

          // Check if the URL starts with http://, https://, or www
          if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('www')) {
            // If not, add http:// to the beginning
            url = 'http://' + url;
          }

          // Redirect to the fetched URL
          console.log('Redirecting to:', url);
          window.location.href = url;
        } else {
          console.error('Link data is missing the "url" property.');
        }
      } else {
        console.error('Link not found.');
      }
    } else {
      console.error('User not found.');
    }
  } catch (error) {
    console.error('Error fetching link data:', error);
  }
}


  // Call the asynchronous function
  fetchLinkData();
</script>
